<#
.SYNOPSIS
  BlackNight GUI - Otimizar o Windows (Interativo, Tema Escuro)
.DESCRIPTION
  Vers√£o final pronta para execu√ß√£o e upload no GitHub.
  - Bot√£o "Otimizar o Windows" abre uma janela interativa com a√ß√µes seguras e com confirma√ß√£o antes de cada passo.
  - A√ß√µes implementadas:
      * Limpar Tempor√°rios (%TEMP%, C:\Windows\Temp, AppData\Local\Temp)
      * Limpar cache do Chrome/Edge (padr√£o)
      * Esvaziar Lixeira (via Shell COM)
      * Limpar cache do Windows Update (SoftwareDistribution\Download) ‚Äî requer Administrador
      * Abrir Gerenciador de Tarefas (sugest√£o para aba Inicializar)
  - Tema: BlackNight (escuro)
  - Para executar via PowerShell: execute o arquivo com PowerShell (recomenda-se executar como Administrador para todas as a√ß√µes funcionarem).
  - Para rodar direto do GitHub com Invoke-RestMethod: 
      iex (irm "https://raw.githubusercontent.com/SeuUsuario/SeuRepo/main/BlackNight_GUI.ps1")
#>

Add-Type -AssemblyName System.Windows.Forms
Add-Type -AssemblyName System.Drawing

# --- Helpers ---
function Ensure-Admin {
    $current = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($current)
    return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

function Show-Message($text, $title="BlackNight") {
    [System.Windows.Forms.MessageBox]::Show($text, $title, 'OK', 'Information') | Out-Null
}

function Confirm-Action($text, $title="Confirma√ß√£o") {
    $res = [System.Windows.Forms.MessageBox]::Show($text, $title, 'YesNo', 'Question')
    return $res -eq [System.Windows.Forms.DialogResult]::Yes
}

# --- Optimization Functions ---

function Remove-ItemSafe($path) {
    try {
        if (Test-Path $path) {
            Get-ChildItem -LiteralPath $path -Force -Recurse -ErrorAction SilentlyContinue | ForEach-Object {
                try { Remove-Item -LiteralPath $_.FullName -Force -Recurse -ErrorAction SilentlyContinue } catch {}
            }
            return $true
        }
        return $false
    } catch {
        return $false
    }
}

function Clean-Temp {
    try {
        $paths = @(
            [IO.Path]::GetTempPath(),
            "C:\Windows\Temp",
            Join-Path $env:LOCALAPPDATA "Temp"
        ) | Select-Object -Unique

        $summary = @()
        if (-not (Confirm-Action "Deseja limpar as pastas tempor√°rias?`n`n$($paths -join \"`n\")")) { return }

        foreach ($p in $paths) {
            if (Test-Path $p) {
                $countBefore = (Get-ChildItem -Path $p -Recurse -Force -ErrorAction SilentlyContinue | Measure-Object).Count
                Remove-ItemSafe -path $p | Out-Null
                $countAfter = (Get-ChildItem -Path $p -Recurse -Force -ErrorAction SilentlyContinue | Measure-Object).Count
                $removed = $countBefore - $countAfter
                $summary += "$p : ~${removed} itens removidos"
            } else {
                $summary += "$p : (n√£o encontrado)"
            }
        }

        Show-Message ("Limpeza conclu√≠da.`n`n" + ($summary -join "`n"))
    }
    catch {
        Show-Message "Erro ao limpar tempor√°rios:`n$($_.Exception.Message)"
    }
}

function Clear-BrowserCache {
    try {
        if (-not (Confirm-Action "Deseja tentar limpar o cache do Chrome e do Edge (padr√µes)?`n(ser√° feita tentativa nas pastas padr√£o de perfil)")) { return }
        $removed = @()
        # Chrome Default
        $chromeCache = Join-Path $env:LOCALAPPDATA "Google\Chrome\User Data\Default\Cache"
        $chromeGPUCache = Join-Path $env:LOCALAPPDATA "Google\Chrome\User Data\Default\GPUCache"
        # Edge Default
        $edgeCache = Join-Path $env:LOCALAPPDATA "Microsoft\Edge\User Data\Default\Cache"
        $edgeGPUCache = Join-Path $env:LOCALAPPDATA "Microsoft\Edge\User Data\Default\GPUCache"

        $candidates = @($chromeCache, $chromeGPUCache, $edgeCache, $edgeGPUCache) | Select-Object -Unique
        foreach ($c in $candidates) {
            if (Test-Path $c) {
                $countBefore = (Get-ChildItem -Path $c -Recurse -Force -ErrorAction SilentlyContinue | Measure-Object).Count
                Remove-ItemSafe -path $c | Out-Null
                $countAfter = (Get-ChildItem -Path $c -Recurse -Force -ErrorAction SilentlyContinue | Measure-Object).Count
                $removed += "$c : ~$($countBefore - $countAfter) itens removidos"
            } else {
                $removed += "$c : (n√£o encontrado)"
            }
        }

        Show-Message ("Limpeza de cache de navegadores conclu√≠da.`n`n" + ($removed -join "`n"))
    }
    catch {
        Show-Message "Erro ao limpar cache do navegador:`n$($_.Exception.Message)"
    }
}

function Empty-RecycleBin {
    try {
        if (-not (Confirm-Action "Deseja esvaziar a Lixeira?")) { return }
        $shell = New-Object -ComObject Shell.Application
        $recycle = $shell.Namespace(0xA)
        # Invoke "Empty Recycle Bin" - may show native UI depending on system
        $recycle.InvokeVerb("Esvaziar Lixeira")
        Show-Message "Comando para esvaziar a lixeira enviado ao Shell."
    }
    catch {
        Show-Message "Erro ao esvaziar Lixeira:`n$($_.Exception.Message)"
    }
}

function Clear-WindowsUpdateCache {
    try {
        if (-not (Confirm-Action "Limpar cache do Windows Update (SoftwareDistribution\\Download)?`n(necessita privil√©gios de Administrador)")) { return }
        if (-not (Ensure-Admin)) {
            Show-Message "Este passo requer execu√ß√£o como Administrador. Reinicie o PowerShell como Administrador e tente novamente."
            return
        }
        Try { Stop-Service -Name wuauserv -Force -ErrorAction Stop } catch {}
        $path = Join-Path $env:SystemRoot "SoftwareDistribution\Download"
        if (Test-Path $path) {
            $countBefore = (Get-ChildItem -Path $path -Recurse -Force -ErrorAction SilentlyContinue | Measure-Object).Count
            Remove-ItemSafe -path $path | Out-Null
            $countAfter = (Get-ChildItem -Path $path -Recurse -Force -ErrorAction SilentlyContinue | Measure-Object).Count
            $removed = $countBefore - $countAfter
            Show-Message "Cache do Windows Update limpo. ~${removed} itens removidos."
        } else {
            Show-Message "Pasta de cache n√£o encontrada: $path"
        }
        Try { Start-Service -Name wuauserv -ErrorAction Stop } catch {}
    }
    catch {
        Show-Message "Erro ao limpar cache do Windows Update:`n$($_.Exception.Message)"
    }
}

function Open-Startup-Manager {
    try {
        if (Confirm-Action "Deseja abrir o Gerenciador de Tarefas (voc√™ pode gerenciar itens de Inicializa√ß√£o na aba 'Inicializar')?") {
            Start-Process "taskmgr"
            Show-Message "Gerenciador de Tarefas aberto. Navegue at√© a aba 'Inicializar' para gerenciar programas."
        }
    }
    catch {
        Show-Message "Erro ao abrir Gerenciador de Tarefas:`n$($_.Exception.Message)"
    }
}

function Show-Startup-Items {
    try {
        # Enumerate common Run keys (HKCU and HKLM)
        $items = @()
        $runHKCU = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
        $runHKLM = "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run"

        foreach ($k in @($runHKCU, $runHKLM)) {
            if (Test-Path $k) {
                Get-ItemProperty -Path $k | ForEach-Object {
                    $_.PSObject.Properties | Where-Object { $_.Name -ne "PSPath" -and $_.Name -ne "PSParentPath" -and $_.Name -ne "PSChildName" -and $_.Name -ne "PSDrive" -and $_.Name -ne "PSProvider" } | ForEach-Object {
                        $items += "$k\$($_.Name) => $($_.Value)"
                    }
                }
            }
        }

        if ($items.Count -eq 0) {
            Show-Message "Nenhum item de inicializa√ß√£o encontrado nos locais pesquisados."
        } else {
            $text = "Itens de inicializa√ß√£o encontrados:`n`n" + ($items -join "`n`n")
            [System.Windows.Forms.Clipboard]::SetText($text)
            Show-Message "Lista de itens de inicializa√ß√£o copiada para a √°rea de transfer√™ncia. Cole em um editor para revisar."
        }
    }
    catch {
        Show-Message "Erro ao listar itens de inicializa√ß√£o:`n$($_.Exception.Message)"
    }
}

# --- Build Optimize Window (Dark Theme) ---
function Show-OptimizeWindow {
    $optForm = New-Object System.Windows.Forms.Form
    $optForm.Text = "Otimizar o Windows - BlackNight"
    $optForm.Size = New-Object System.Drawing.Size(480,320)
    $optForm.StartPosition = "CenterParent"
    $optForm.FormBorderStyle = "FixedDialog"
    $optForm.MaximizeBox = $false
    $optForm.MinimizeBox = $false
    $optForm.BackColor = [System.Drawing.Color]::FromArgb(24,24,24)

    $lbl = New-Object System.Windows.Forms.Label
    $lbl.AutoSize = $true
    $lbl.Location = New-Object System.Drawing.Point(14,12)
    $lbl.ForeColor = [System.Drawing.Color]::White
    $lbl.Text = "Escolha a a√ß√£o de otimiza√ß√£o que deseja executar:"
    $optForm.Controls.Add($lbl)

    $btnCleanTemp = New-Object System.Windows.Forms.Button
    $btnCleanTemp.Location = New-Object System.Drawing.Point(18,50)
    $btnCleanTemp.Size = New-Object System.Drawing.Size(220,44)
    $btnCleanTemp.Text = "üßπ Limpar Tempor√°rios"
    $btnCleanTemp.FlatStyle = 'System'
    $btnCleanTemp.BackColor = [System.Drawing.Color]::FromArgb(40,40,40)
    $btnCleanTemp.ForeColor = [System.Drawing.Color]::White
    $btnCleanTemp.Add_Click({ Clean-Temp })
    $optForm.Controls.Add($btnCleanTemp)

    $btnBrowser = New-Object System.Windows.Forms.Button
    $btnBrowser.Location = New-Object System.Drawing.Point(250,50)
    $btnBrowser.Size = New-Object System.Drawing.Size(200,44)
    $btnBrowser.Text = "üåê Limpar Cache do Navegador"
    $btnBrowser.FlatStyle = 'System'
    $btnBrowser.BackColor = [System.Drawing.Color]::FromArgb(40,40,40)
    $btnBrowser.ForeColor = [System.Drawing.Color]::White
    $btnBrowser.Add_Click({ Clear-BrowserCache })
    $optForm.Controls.Add($btnBrowser)

    $btnEmptyRecycle = New-Object System.Windows.Forms.Button
    $btnEmptyRecycle.Location = New-Object System.Drawing.Point(18,110)
    $btnEmptyRecycle.Size = New-Object System.Drawing.Size(220,44)
    $btnEmptyRecycle.Text = "üóëÔ∏è Esvaziar Lixeira"
    $btnEmptyRecycle.BackColor = [System.Drawing.Color]::FromArgb(40,40,40)
    $btnEmptyRecycle.ForeColor = [System.Drawing.Color]::White
    $btnEmptyRecycle.Add_Click({ Empty-RecycleBin })
    $optForm.Controls.Add($btnEmptyRecycle)

    $btnClearWU = New-Object System.Windows.Forms.Button
    $btnClearWU.Location = New-Object System.Drawing.Point(250,110)
    $btnClearWU.Size = New-Object System.Drawing.Size(200,44)
    $btnClearWU.Text = "üì• Limpar cache do Windows Update"
    $btnClearWU.BackColor = [System.Drawing.Color]::FromArgb(40,40,40)
    $btnClearWU.ForeColor = [System.Drawing.Color]::White
    $btnClearWU.Add_Click({ Clear-WindowsUpdateCache })
    $optForm.Controls.Add($btnClearWU)

    $btnStartup = New-Object System.Windows.Forms.Button
    $btnStartup.Location = New-Object System.Drawing.Point(18,170)
    $btnStartup.Size = New-Object System.Drawing.Size(220,44)
    $btnStartup.Text = "üöÄ Abrir Gerenciador de Tarefas"
    $btnStartup.BackColor = [System.Drawing.Color]::FromArgb(40,40,40)
    $btnStartup.ForeColor = [System.Drawing.Color]::White
    $btnStartup.Add_Click({ Open-Startup-Manager })
    $optForm.Controls.Add($btnStartup)

    $btnListStartup = New-Object System.Windows.Forms.Button
    $btnListStartup.Location = New-Object System.Drawing.Point(250,170)
    $btnListStartup.Size = New-Object System.Drawing.Size(200,44)
    $btnListStartup.Text = "üìã Listar Itens de Inicializa√ß√£o"
    $btnListStartup.BackColor = [System.Drawing.Color]::FromArgb(40,40,40)
    $btnListStartup.ForeColor = [System.Drawing.Color]::White
    $btnListStartup.Add_Click({ Show-Startup-Items })
    $optForm.Controls.Add($btnListStartup)

    $btnClose = New-Object System.Windows.Forms.Button
    $btnClose.Location = New-Object System.Drawing.Point(180,240)
    $btnClose.Size = New-Object System.Drawing.Size(120,36)
    $btnClose.Text = "Fechar"
    $btnClose.BackColor = [System.Drawing.Color]::FromArgb(60,60,60)
    $btnClose.ForeColor = [System.Drawing.Color]::White
    $btnClose.Add_Click({ $optForm.Close() })
    $optForm.Controls.Add($btnClose)

    $optForm.ShowDialog() | Out-Null
}

# --- MAIN GUI (BlackNight style) ---
$form = New-Object System.Windows.Forms.Form
$form.Text = "BlackNight - Painel"
$form.Size = New-Object System.Drawing.Size(680,460)
$form.StartPosition = "CenterScreen"
$form.BackColor = [System.Drawing.Color]::FromArgb(12,12,12)

# Title label
$lblTitle = New-Object System.Windows.Forms.Label
$lblTitle.Text = "BlackNight - Painel"
$lblTitle.Font = New-Object System.Drawing.Font("Segoe UI",18,[System.Drawing.FontStyle]::Bold)
$lblTitle.AutoSize = $true
$lblTitle.Location = New-Object System.Drawing.Point(18,14)
$lblTitle.ForeColor = [System.Drawing.Color]::White
$form.Controls.Add($lblTitle)

# Subtitle
$lblSub = New-Object System.Windows.Forms.Label
$lblSub.Text = "Painel de ferramentas ‚Äî clique nas op√ß√µes abaixo."
$lblSub.Font = New-Object System.Drawing.Font("Segoe UI",9,[System.Drawing.FontStyle]::Regular)
$lblSub.AutoSize = $true
$lblSub.Location = New-Object System.Drawing.Point(20,50)
$lblSub.ForeColor = [System.Drawing.Color]::Gray
$form.Controls.Add($lblSub)

# Example button (placeholder)
$btnExample = New-Object System.Windows.Forms.Button
$btnExample.Location = New-Object System.Drawing.Point(18,90)
$btnExample.Size = New-Object System.Drawing.Size(200,44)
$btnExample.Text = "Exemplo: Outra Op√ß√£o"
$btnExample.BackColor = [System.Drawing.Color]::FromArgb(30,30,30)
$btnExample.ForeColor = [System.Drawing.Color]::White
$btnExample.Add_Click({ Show-Message "Clique detectado em outra op√ß√£o." })
$form.Controls.Add($btnExample)

# Optimize button
$btnOptimize = New-Object System.Windows.Forms.Button
$btnOptimize.Location = New-Object System.Drawing.Point(240,90)
$btnOptimize.Size = New-Object System.Drawing.Size(260,44)
$btnOptimize.Text = "Otimizar o Windows"
$btnOptimize.BackColor = [System.Drawing.Color]::FromArgb(40,40,40)
$btnOptimize.ForeColor = [System.Drawing.Color]::White
$btnOptimize.Font = New-Object System.Drawing.Font("Segoe UI",10,[System.Drawing.FontStyle]::Bold)
$btnOptimize.Add_Click({ Show-OptimizeWindow })
$form.Controls.Add($btnOptimize)

# Status bar
$status = New-Object System.Windows.Forms.StatusStrip
$statusLabel = New-Object System.Windows.Forms.ToolStripStatusLabel
$statusLabel.Text = "Pronto"
$statusLabel.ForeColor = [System.Drawing.Color]::White
$status.Items.Add($statusLabel) | Out-Null
$form.Controls.Add($status)

# Show main form
[void]$form.ShowDialog()
